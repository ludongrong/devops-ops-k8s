= kubernetes
Author 卢冬榕
:doctype: article
:encoding: utf-8
:lang: en
:toc: left
:numbered:


= kubernetes

== `kubernetes` 是什么？

Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications.

image::./README/components-of-kubernetes.png[align="center"]

[NOTE]
====
https://kubernetes.io
====

- 代码托管 - https://github.com/kubernetes/kubernetes

- 社区 - https://github.com/kubernetes/community

=== `kubernetes` 具备哪些解决能力？

- Service discovery and load balancing（服务发现和负载均衡）
- Storage orchestration（存储编排）

[NOTE]
====
https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/
====

=== `kubernetes` 的工作原理是什么？

- Control Plane Components

kube-apiserver、etcd、kube-scheduler、kube-controller-manager、cloud-controller-manager

- Node Components

kubelet、kube-proxy、Container Runtime

- Addons

DNS、Dashboard

image::./README/kubernetes-components.png[align="center"]

[NOTE]
====
https://kubernetes.io/docs/concepts/overview/components/
====

==== `Traditional deployment` 跟 `Container deployment` 的差异

image::./README/container_evolution.png[align="center"]

[NOTE]
====
https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/
====

=== `kubernetes` 的 `CRI`

`CRI` 是 Container Runtime Interface 的缩写。凡是支持CRI的容器运行时，皆可作为K8S的底层容器运行时。

image::./README/2021-05-04_11-47-02.png[align="center"]

如果你使用containerd作为K8S容器运行时的话，由于containerd内置了 CRI 插件，kubelet可以直接调用containerd。

image::./README/2021-05-04_11-47-03.png[align="center"]

==== 为什么弃用 `k8s+docker`？

如果你使用Docker作为K8S容器运行时的话，kubelet需要先要通过 dockershim 去调用Docker，再通过Docker去调用containerd。

==== `kubernetes` 的 `k8s+containerd`

image::./README/2021-05-04_11-48-59.png[align="center"]

==== `kubernetes` 的 `k8s+cri-o`

image::./README/2021-05-04_11-47-01.png[align="center"]

== 搭建 `k8s+containerd` 环境

- `ansible` 方式 - https://faun.pub/how-to-create-your-own-kubernetes-cluster-using-ansible-7c6b5c031a5d

=== 下载 `kubernetes`

==== 编译方式

```
git clone https://github.com/kubernetes/kubernetes
cd kubernetes
make
```

You have a working Docker environment.

```
git clone https://github.com/kubernetes/kubernetes
cd kubernetes
make quick-release
```

==== 下载现成

image::./README/2021-05-04_11-47-04.png[align="center"]

=== 安装 `etcd`

https://github.com/ludongrong/devops/tree/main/41-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83

=== 安装 `calicoctl`

https://www.kancloud.cn/willfeng/k8s/654128

- https://github.com/projectcalico/calico

- https://docs.projectcalico.org/about/about-calico

==== `kubernetes` 方式安装

https://docs.projectcalico.org/getting-started/kubernetes/flannel/flannel

==== `etc` 方式安装

https://docs.projectcalico.org/getting-started/calicoctl/configure/etcd

[source,sh]
----
cd /opt/k8s/work
curl -O -L  https://github.com/projectcalico/calicoctl/releases/download/v3.12.0/calicoctl
mv calicoctl ../bin
chmod +x /opt/k8s/bin/calicoctl
----

配置

[source,sh]
----
cd /opt/k8s/work
source /opt/k8s/bin/environment.sh
cat > calicoctl.cfg <<EOF
apiVersion: projectcalico.org/v3
kind: CalicoAPIConfig
metadata:
spec:
  etcdEndpoints: ${ETCD_ENDPOINTS}
  etcdKeyFile: /etc/calico/key.pem
  etcdCertFile: /etc/calico/cert.pem
  etcdCACertFile: /etc/calico/ca.pem
EOF
----

查看

[source,sh]
----
# 查看所有calico节点状态
calicoctl node status
calicoctl get nodes
calicoctl get ippool
# 查看集群ipPool情况
calicoctl get ipPool -o yaml

kubectl get pods -n kube-system -owide
----

[source,sh]
----
cd /opt/k8s/work
source /opt/k8s/bin/environment.sh
for node_ip in ${NODE_IPS[@]}
  do
    echo ">>> ${node_ip}"
    ssh root@${node_ip} "systemctl status etcd|grep Active"
  done
----

== 维护 `kubernetes` 环境

=== 通过 `kubectl` 查看日志

[source,sh]
----
kubectl describe pod kubernetes-dashboard-849cd79b75-s2snt --namespace kube-system
kubectl logs -f pods/monitoring-influxdb-fc8f8d5cd-dbs7d -n kube-system
kubectl logs --tail 200 -f kube-apiserver -n kube-system |more
kubectl logs --tail 200 -f podname -n jenkins
----

[NOTE]
====
使用Kubelet describe 查看日志，一定要带上 命名空间，否则会报如下错误。如：kubectl describe pod coredns-6c65fc5cbb-8ntpv。报错 Error from server (NotFound): pods "coredns-6c65fc5cbb-8ntpv" not found。
====

=== 通过 `journalctl` 查看日志

[source,sh]
----
journalctl -u kube-scheduler
journalctl -xefu kubelet
journalctl -u kube-apiserver
journalctl -u kubelet |tail
journalctl -xe
----

=== 通过 `系统` 查看日志

[source,sh]
----
cat /var/log/messages
----